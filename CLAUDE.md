# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Authoritative treadmill compatibility database for FitOSC and VRTI applications. This is a data-driven project that uses JSON Schema validation and automated compilation to maintain a single source of truth for treadmill hardware compatibility.

## Essential Commands

```bash
# Install dependencies
npm install

# Validate individual treadmill files
npm run validate

# Compile individual files into data/treadmills.json
npm run compile

# Validate compiled dataset
npm run validate:compiled
```

## Architecture

### Data Flow
Individual treadmill JSON files (`data/treadmills/*.json`) are the source of truth. The compilation script (`scripts/compile.js`) aggregates them into a single `data/treadmills.json` file with metadata (generatedAt, schemaVersion).

### Schema Validation
Three-tier schema structure using JSON Schema Draft 7:
- `schema/features.schema.json`: Array of supported feature strings. Valid values:
  - `speedControl`: Remote speed control capability
  - `inclineControl`: Remote incline control capability
  - `cadence`: Cadence measurement (steps per minute)
  - `calories`: Calorie expenditure tracking
  - `heartRate`: Heart rate monitoring
  - `steps`: Step count tracking
  - Only include features that are supported; omit unsupported features from the array
- `schema/treadmill.schema.json`: Defines individual treadmill structure. References features.schema.json. Includes required fields (id, make, model, driver, source, features, sharedNotes) and optional fields (weight, vendorApps)
- `schema/treadmills.schema.json`: Defines compiled dataset structure with meta object and array of treadmills

All schemas use `additionalProperties: false` for strict validation. All devices have Bluetooth connectivity.

### Driver Names
Restricted to specific values (can be expanded as needed):
- `Kingsmith Walking Pad`: Kingsmith proprietary Bluetooth driver
- `Generic`: Generic Bluetooth FTMS driver

### Git Pre-Commit Hook
Installed automatically via `npm install` (package.json `prepare` script runs `scripts/install-hooks.sh`). When committing changes to `data/treadmills/*.json`, the hook:
1. Runs `node scripts/compile.js`
2. Auto-stages `data/treadmills.json` if changed
3. Includes it in the commit

This ensures the compiled dataset is always in sync with individual files.

### Vendor Apps
Optional field for third-party fitness apps:
- `vendorApps`: array of objects with `name`, `supported`, and optional `notes`
- Valid app names (enum): `URevo`, `Kinomap`, `Zwift`, `KSFit`
- Kingsmith models support KSFit app; UREVO models support URevo app

## Data Rules

- **Never edit `data/treadmills.json` directly** - it's auto-generated by compile.js
- **`sharedNotes` is for human contributors only** - don't auto-populate with specifications
- No null values - omit optional fields if unknown
- `source.url` must be a valid URI format (validated by ajv-formats)
- Features are stored as an array of supported capability strings only
- File naming convention: `brand-model.json` (lowercase, hyphenated)
- `id` field should match filename without .json extension

## Adding/Modifying Treadmills

1. Create/edit file in `data/treadmills/` following schema/treadmill.schema.json
2. Run `npm run validate` to check individual file
3. Run `npm run compile` to regenerate data/treadmills.json
4. Run `npm run validate:compiled` to verify output
5. Commit - pre-commit hook will auto-compile if you forget

## CI/CD

GitHub Actions workflow (`.github/workflows/build.yml`) runs on pushes to data/schema/scripts:
1. Validates individual treadmill files
2. Compiles dataset
3. Validates compiled dataset
4. Fails if compiled file is out of sync (prevents manual edits)